services:
    laravel.test:
        build:
            context: './vendor/laravel/sail/runtimes/8.4'
            dockerfile: Dockerfile
            args:
                WWWGROUP: '${WWWGROUP}'
        image: 'sail-8.4/app'
        extra_hosts:
            - 'host.docker.internal:host-gateway'
        ports:
            - '${APP_PORT:-80}:80'
            - '${VITE_PORT:-5173}:${VITE_PORT:-5173}'
        environment:
            WWWUSER: '${WWWUSER}'
            LARAVEL_SAIL: 1
            XDEBUG_MODE: '${SAIL_XDEBUG_MODE:-off}'
            XDEBUG_CONFIG: '${SAIL_XDEBUG_CONFIG:-client_host=host.docker.internal}'
            IGNITION_LOCAL_SITES_PATH: '${PWD}'
        volumes:
            - '.:/var/www/html'
        networks:
            - sail
        depends_on:
            - pgsql
            - redis
    horizon:
        build:
            context: './vendor/laravel/sail/runtimes/8.4'
            dockerfile: Dockerfile
            args:
                WWWGROUP: '${WWWGROUP}'
        image: 'sail-8.4/app'
        extra_hosts:
            - 'host.docker.internal:host-gateway'
        environment:
            WWWUSER: '${WWWUSER}'
            LARAVEL_SAIL: 1
            XDEBUG_MODE: '${SAIL_XDEBUG_MODE:-off}'
            XDEBUG_CONFIG: '${SAIL_XDEBUG_CONFIG:-client_host=host.docker.internal}'
            IGNITION_LOCAL_SITES_PATH: '${PWD}'
        volumes:
            - '.:/var/www/html'
        networks:
            - sail
        depends_on:
            - pgsql
            - redis
        command: php artisan horizon

    reverb:
        build:
            context: './vendor/laravel/sail/runtimes/8.4'
            dockerfile: Dockerfile
            args:
                WWWGROUP: '${WWWGROUP}'
        image: 'sail-8.4/app'
        extra_hosts:
            - 'host.docker.internal:host-gateway'
        environment:
            WWWUSER: '${WWWUSER}'
            LARAVEL_SAIL: 1
        volumes:
            - '.:/var/www/html'
        networks:
            - sail
        depends_on:
            - redis
        ports:
            - '${REVERB_SERVER_PORT:-8080}:8080'
        command: php artisan reverb:start --host=0.0.0.0 --port=8080 --debug

    pgsql:
        image: 'postgres:18-alpine'
        ports:
            - '${FORWARD_DB_PORT:-5432}:5432'
        environment:
            PGPASSWORD: '${DB_PASSWORD:-secret}'
            POSTGRES_DB: '${DB_DATABASE}'
            POSTGRES_USER: '${DB_USERNAME}'
            POSTGRES_PASSWORD: '${DB_PASSWORD:-secret}'
        volumes:
            - 'sail-pgsql:/var/lib/postgresql/data'
            - './vendor/laravel/sail/database/pgsql/create-testing-database.sql:/docker-entrypoint-initdb.d/10-create-testing-database.sql'
        networks:
            - sail
        healthcheck:
            test:
                - CMD
                - pg_isready
                - '-q'
                - '-d'
                - '${DB_DATABASE}'
                - '-U'
                - '${DB_USERNAME}'
            retries: 3
            timeout: 5s
    redis:
        image: 'redis:alpine'
        ports:
            - '${FORWARD_REDIS_PORT:-6379}:6379'
        volumes:
            - 'sail-redis:/data'
        networks:
            - sail
        healthcheck:
            test:
                - CMD
                - redis-cli
                - ping
            retries: 3
            timeout: 5s
    ai-service:
        volumes:
            - ./ai-service:/app
            - ai-service-logs:/app/logs
        build:
            context: ./ai-service
            dockerfile: Dockerfile
        container_name: ai-service
        env_file:
            - ./ai-service/.env
        environment:
            # Concurrency settings - ajustar según capacidad del servidor
            # MAX_CONCURRENT_REQUESTS controla cuántas alertas se procesan en paralelo
            MAX_CONCURRENT_REQUESTS: ${AI_MAX_CONCURRENT_REQUESTS:-5}
            SEMAPHORE_TIMEOUT: ${AI_SEMAPHORE_TIMEOUT:-30.0}
            RATE_LIMITING_ENABLED: ${AI_RATE_LIMITING_ENABLED:-true}
            # Logging
            ENVIRONMENT: ${APP_ENV:-local}
            LOG_LEVEL: ${LOG_LEVEL:-INFO}
            LOG_FILE: /app/logs/ai-service.json
        ports:
            - '8000:8000'
        networks:
            - sail
        depends_on:
            - redis
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 512M
        # ESCALADO HORIZONTAL:
        # Para producción con múltiples instancias:
        # 1. Remover container_name y ports
        # 2. Usar un load balancer (nginx, traefik, etc.)
        # 3. Ejecutar: docker compose up --scale ai-service=3
    
    # ============================================================================
    # GRAFANA ALLOY - Log Collector for Grafana Cloud
    # ============================================================================
    # Collects JSON logs from Laravel and AI Service, ships to Grafana Cloud Loki
    grafana-alloy:
        image: grafana/alloy:latest
        container_name: grafana-alloy
        restart: unless-stopped
        volumes:
            - ./storage/logs:/var/log/app:ro
            - ai-service-logs:/var/log/ai-service:ro
            - ./docker/alloy-config.alloy:/etc/alloy/config.alloy:ro
        environment:
            GRAFANA_LOKI_URL: ${GRAFANA_LOKI_URL:-}
            GRAFANA_LOKI_USER: ${GRAFANA_LOKI_USER:-}
            GRAFANA_LOKI_TOKEN: ${GRAFANA_LOKI_TOKEN:-}
            CLUSTER_NAME: ${CLUSTER_NAME:-local}
        networks:
            - sail
        depends_on:
            - laravel.test
            - ai-service
        command: ["run", "/etc/alloy/config.alloy"]
        profiles:
            - logging  # Only start with: docker compose --profile logging up
    
    # ============================================================================
    # LANGFUSE OBSERVABILITY PLATFORM
    # ============================================================================
    langfuse-web:
        image: docker.io/langfuse/langfuse:3
        container_name: langfuse-web
        restart: unless-stopped
        depends_on:
            pgsql:
                condition: service_healthy
            redis:
                condition: service_healthy
            clickhouse:
                condition: service_healthy
            minio:
                condition: service_healthy
        ports:
            - '3030:3000'
        networks:
            - sail
        environment:
            # Database (reusing existing PostgreSQL)
            DATABASE_URL: 'postgresql://${DB_USERNAME}:${DB_PASSWORD:-secret}@pgsql:5432/langfuse'
            
            # NextAuth
            NEXTAUTH_URL: '${LANGFUSE_URL:-http://localhost:3030}'
            NEXTAUTH_SECRET: '${LANGFUSE_NEXTAUTH_SECRET:-changeme-generate-via-openssl-rand-hex-32}'
            
            # Security
            SALT: '${LANGFUSE_SALT:-changeme-mysalt}'
            ENCRYPTION_KEY: '${LANGFUSE_ENCRYPTION_KEY:-0000000000000000000000000000000000000000000000000000000000000000}'
            
            # ClickHouse
            CLICKHOUSE_MIGRATION_URL: 'clickhouse://clickhouse:9000'
            CLICKHOUSE_URL: 'http://clickhouse:8123'
            CLICKHOUSE_USER: '${CLICKHOUSE_USER:-clickhouse}'
            CLICKHOUSE_PASSWORD: '${CLICKHOUSE_PASSWORD:-clickhouse}'
            CLICKHOUSE_CLUSTER_ENABLED: 'false'
            
            # S3/MinIO Storage
            LANGFUSE_S3_EVENT_UPLOAD_BUCKET: 'langfuse'
            LANGFUSE_S3_EVENT_UPLOAD_REGION: 'auto'
            LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: '${MINIO_ROOT_USER:-minio}'
            LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: '${MINIO_ROOT_PASSWORD:-miniosecret}'
            LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: 'http://minio:9000'
            LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: 'true'
            LANGFUSE_S3_EVENT_UPLOAD_PREFIX: 'events/'
            
            LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: 'langfuse'
            LANGFUSE_S3_MEDIA_UPLOAD_REGION: 'auto'
            LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: '${MINIO_ROOT_USER:-minio}'
            LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: '${MINIO_ROOT_PASSWORD:-miniosecret}'
            LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: 'http://localhost:9090'
            LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: 'true'
            LANGFUSE_S3_MEDIA_UPLOAD_PREFIX: 'media/'
            
            # Redis (reusing existing Redis)
            REDIS_HOST: 'redis'
            REDIS_PORT: '6379'
            REDIS_AUTH: '${REDIS_PASSWORD:-}'
            REDIS_TLS_ENABLED: 'false'
            
            # Features
            TELEMETRY_ENABLED: '${LANGFUSE_TELEMETRY_ENABLED:-true}'
            LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: 'true'
            
            # Initial Setup (optional - for auto-creating org/project)
            LANGFUSE_INIT_USER_EMAIL: '${LANGFUSE_INIT_USER_EMAIL:-}'
            LANGFUSE_INIT_USER_PASSWORD: '${LANGFUSE_INIT_USER_PASSWORD:-}'
            LANGFUSE_INIT_USER_NAME: '${LANGFUSE_INIT_USER_NAME:-}'
            LANGFUSE_INIT_ORG_ID: '${LANGFUSE_INIT_ORG_ID:-}'
            LANGFUSE_INIT_ORG_NAME: '${LANGFUSE_INIT_ORG_NAME:-}'
            LANGFUSE_INIT_PROJECT_ID: '${LANGFUSE_INIT_PROJECT_ID:-}'
            LANGFUSE_INIT_PROJECT_NAME: '${LANGFUSE_INIT_PROJECT_NAME:-}'
            LANGFUSE_INIT_PROJECT_PUBLIC_KEY: '${LANGFUSE_INIT_PROJECT_PUBLIC_KEY:-}'
            LANGFUSE_INIT_PROJECT_SECRET_KEY: '${LANGFUSE_INIT_PROJECT_SECRET_KEY:-}'
    
    langfuse-worker:
        image: docker.io/langfuse/langfuse-worker:3
        container_name: langfuse-worker
        restart: unless-stopped
        depends_on:
            pgsql:
                condition: service_healthy
            redis:
                condition: service_healthy
            clickhouse:
                condition: service_healthy
            minio:
                condition: service_healthy
        networks:
            - sail
        environment:
            # Same environment as langfuse-web
            DATABASE_URL: 'postgresql://${DB_USERNAME}:${DB_PASSWORD:-secret}@pgsql:5432/langfuse'
            NEXTAUTH_URL: '${LANGFUSE_URL:-http://localhost:3030}'
            SALT: '${LANGFUSE_SALT:-changeme-mysalt}'
            ENCRYPTION_KEY: '${LANGFUSE_ENCRYPTION_KEY:-0000000000000000000000000000000000000000000000000000000000000000}'
            CLICKHOUSE_MIGRATION_URL: 'clickhouse://clickhouse:9000'
            CLICKHOUSE_URL: 'http://clickhouse:8123'
            CLICKHOUSE_USER: '${CLICKHOUSE_USER:-clickhouse}'
            CLICKHOUSE_PASSWORD: '${CLICKHOUSE_PASSWORD:-clickhouse}'
            CLICKHOUSE_CLUSTER_ENABLED: 'false'
            LANGFUSE_S3_EVENT_UPLOAD_BUCKET: 'langfuse'
            LANGFUSE_S3_EVENT_UPLOAD_REGION: 'auto'
            LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: '${MINIO_ROOT_USER:-minio}'
            LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: '${MINIO_ROOT_PASSWORD:-miniosecret}'
            LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: 'http://minio:9000'
            LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: 'true'
            LANGFUSE_S3_EVENT_UPLOAD_PREFIX: 'events/'
            LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: 'langfuse'
            LANGFUSE_S3_MEDIA_UPLOAD_REGION: 'auto'
            LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: '${MINIO_ROOT_USER:-minio}'
            LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: '${MINIO_ROOT_PASSWORD:-miniosecret}'
            LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: 'http://localhost:9090'
            LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: 'true'
            LANGFUSE_S3_MEDIA_UPLOAD_PREFIX: 'media/'
            REDIS_HOST: 'redis'
            REDIS_PORT: '6379'
            REDIS_AUTH: '${REDIS_PASSWORD:-}'
            REDIS_TLS_ENABLED: 'false'
            TELEMETRY_ENABLED: '${LANGFUSE_TELEMETRY_ENABLED:-true}'
            LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: 'true'
    
    clickhouse:
        image: docker.io/clickhouse/clickhouse-server:latest
        container_name: langfuse-clickhouse
        restart: unless-stopped
        user: '101:101'
        ports:
            - '127.0.0.1:8123:8123'
            - '127.0.0.1:9009:9000'
        networks:
            - sail
        environment:
            CLICKHOUSE_DB: 'default'
            CLICKHOUSE_USER: '${CLICKHOUSE_USER:-clickhouse}'
            CLICKHOUSE_PASSWORD: '${CLICKHOUSE_PASSWORD:-clickhouse}'
        volumes:
            - sail-clickhouse-data:/var/lib/clickhouse
            - sail-clickhouse-logs:/var/log/clickhouse-server
        healthcheck:
            test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8123/ping']
            interval: 5s
            timeout: 5s
            retries: 10
            start_period: 10s
    
    minio:
        image: docker.io/minio/minio:latest
        container_name: langfuse-minio
        restart: unless-stopped
        entrypoint: sh
        command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
        ports:
            - '9090:9000'
            - '127.0.0.1:9091:9001'
        networks:
            - sail
        environment:
            MINIO_ROOT_USER: '${MINIO_ROOT_USER:-minio}'
            MINIO_ROOT_PASSWORD: '${MINIO_ROOT_PASSWORD:-miniosecret}'
        volumes:
            - sail-minio-data:/data
        healthcheck:
            test: ['CMD', 'mc', 'ready', 'local']
            interval: 5s
            timeout: 5s
            retries: 5
            start_period: 5s

networks:
    sail:
        driver: bridge
volumes:
    sail-pgsql:
        driver: local
    sail-redis:
        driver: local
    sail-clickhouse-data:
        driver: local
    sail-clickhouse-logs:
        driver: local
    sail-minio-data:
        driver: local
    ai-service-logs:
        driver: local